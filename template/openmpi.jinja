

# IB drivers for MPI (https://community.mellanox.com/docs/DOC-2431)
# TODO: install MLNX_OFED
RUN apt-get update && apt-get install -y --no-install-recommends \
  libhwloc-plugins \
  libhwloc5 \
  infiniband-diags \
  libibverbs* \
  ibacm \
  librdmacm* \
  libmlx4* \
  libmlx5* \
  libpsm-infinipath1 \
  mstflint \
  libibcm.* \
  libibmad.* \
  libibumad* \
  opensm \
  srptools \
  libmlx4-dev \
  rdmacm-utils \
  ibverbs-utils \
  perftest \
  vlan \
  ibutils \
  libnl-3-200 \
  libnl-route-3-200 \
  libnl-route-3-dev \
  libnl-utils \
  libnuma-dev \
  libpciaccess0 \
  byacc \
  flex \
  && rm -rf /var/lib/apt/lists/*


RUN curl -sSL https://www.open-mpi.org/software/ompi/v{{ OPENMPI_VERSION[0:3] }}/downloads/openmpi-{{ OPENMPI_VERSION }}.tar.bz2 \
   | tar -xjC /root \
   && cd /root/openmpi-{{ OPENMPI_VERSION }} \
   && ./configure --prefix=/usr \
                  --with-verbs \
                  --disable-dlopen --enable-shared \
   && make install -j8 \
   && rm -rf /root/openmpi-{{ OPENMPI_VERSION }}

RUN curl -sSL http://mvapich.cse.ohio-state.edu/download/mvapich/osu-micro-benchmarks-{{ OSU_MICROBENCHMARK_VERSION }}.tar.gz \
   | tar -xzC /root \
   && cd /root/osu-micro-benchmarks-{{ OSU_MICROBENCHMARK_VERSION }} \
   && ./configure --prefix=/opt/osu-micro-benchmarks CC=`which mpicc` CXX=`which mpicxx` \
   && cd mpi \
   && make install -j8 \
   && rm -rf /root/osu-micro-benchmarks-{{ OSU_MICROBENCHMARK_VERSION }}
